<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ferremas - Tienda</title>
  <style>
    body {
      background-color: #f4f4f4;
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
    }
    .busqueda {
      margin: 10px 0;
    }
    input[type="text"], input[type="number"] {
      padding: 8px;
      width: 250px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 3px 5px 3px 0;
    }
    button:hover {
      background-color: #0056b3;
    }
    .producto, .carrito-producto {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 10px auto;
      max-width: 500px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
    }
    .producto p, .carrito-producto p {
      margin: 5px 0;
    }
    #producto-container, #carrito-container {
      max-width: 520px;
      margin: 0 auto 40px;
    }
    #carrito-container {
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 10px;
      background: #e9f0ff;
    }
    #carrito-container h2 {
      margin-top: 0;
    }
    .precio-convertido {
      margin-top: 20px;
      font-weight: bold;
    }
    .flex-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .text-right {
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>FERREMAS - Tienda</h1>

  <div class="busqueda">
    <input type="text" id="codigoInput" placeholder="Buscar por c贸digo" />
    <button onclick="buscarPorCodigo()">Buscar</button>
  </div>

  <div class="busqueda">
    <input type="text" id="nombreInput" placeholder="Buscar por nombre" />
    <button onclick="buscarPorNombre()">Buscar</button>
  </div>

  <div class="busqueda">
    <input type="text" id="categoriaInput" placeholder="Buscar por categor铆a" />
    <button onclick="buscarPorCategoria()">Buscar</button>
  </div>

  <div class="busqueda">
    <input type="number" id="stockInput" placeholder="Stock menor a..." />
    <button onclick="buscarPorStock()">Buscar</button>
  </div>

  <div id="producto-container"></div>

  <h2>Carrito de Compras</h2>
  <div id="carrito-container">
    <p id="carrito-vacio">No hay productos en el carrito.</p>
    <div id="carrito-productos"></div>
    <p class="text-right" id="total-carrito"></p>
    <button id="btn-pagar" onclick="pagarCarrito()" style="display:none;">Pagar todo con Webpay</button>
  </div>

  <div class="precio-convertido" id="precio-convertido"></div>

<script>
  // Carrito almacenado en localStorage
  let carrito = JSON.parse(localStorage.getItem('carritoFerremas')) || [];

  function guardarCarrito() {
    localStorage.setItem('carritoFerremas', JSON.stringify(carrito));
  }

  function actualizarCarrito() {
    const contenedor = document.getElementById('carrito-productos');
    const vacioMsg = document.getElementById('carrito-vacio');
    const totalElem = document.getElementById('total-carrito');
    const btnPagar = document.getElementById('btn-pagar');

    if (carrito.length === 0) {
      contenedor.innerHTML = '';
      vacioMsg.style.display = 'block';
      totalElem.textContent = '';
      btnPagar.style.display = 'none';
      return;
    }

    vacioMsg.style.display = 'none';
    btnPagar.style.display = 'inline-block';

    contenedor.innerHTML = carrito.map((item, idx) => `
      <div class="carrito-producto flex-row" >
        <div>
          <strong>${item.nombre}</strong><br>
          Precio: $${item.precio.toFixed(0)}<br>
          Cantidad: <input type="number" min="1" value="${item.cantidad}" onchange="cambiarCantidad(${idx}, this.value)" style="width:50px;">
        </div>
        <div class="text-right">
          <button onclick="eliminarProducto(${idx})" style="background-color:#dc3545;">Eliminar</button>
          <p><strong>Subtotal:</strong> $${(item.precio * item.cantidad).toFixed(0)}</p>
        </div>
      </div>
    `).join('');

    const total = carrito.reduce((sum, item) => sum + item.precio * item.cantidad, 0);
    totalElem.textContent = `Total: $${total.toFixed(0)}`;
  }

  function agregarAlCarrito(producto) {
    // Verifica si ya existe, suma cantidades
    const index = carrito.findIndex(p => p.codigoProducto === producto.codigoProducto);
    if (index >= 0) {
      carrito[index].cantidad++;
    } else {
      carrito.push({...producto, cantidad: 1});
    }
    guardarCarrito();
    actualizarCarrito();
    alert(`Producto "${producto.nombre}" agregado al carrito.`);
  }

  function cambiarCantidad(index, cantidad) {
    cantidad = parseInt(cantidad);
    if (cantidad < 1) cantidad = 1;
    carrito[index].cantidad = cantidad;
    guardarCarrito();
    actualizarCarrito();
  }

  function eliminarProducto(index) {
    carrito.splice(index, 1);
    guardarCarrito();
    actualizarCarrito();
  }

  // Funciones de b煤squeda y mostrar productos (igual que antes pero con bot贸n agregar al carrito)
  function buscarPorCodigo() {
    const codigo = document.getElementById("codigoInput").value;
    if (!codigo) return alert('Ingrese un c贸digo');
    fetch(`/productos/codigo/${codigo}`)
      .then(res => res.json())
      .then(producto => mostrarProducto(producto))
      .catch(() => alert("Producto no encontrado"));
  }

  function buscarPorNombre() {
    const nombre = document.getElementById("nombreInput").value;
    if (!nombre) return alert('Ingrese un nombre');
    fetch(`/productos/nombre/${nombre}`)
      .then(res => res.json())
      .then(lista => mostrarProductos(lista))
      .catch(() => alert("No se encontraron productos"));
  }

  function buscarPorCategoria() {
    const cat = document.getElementById("categoriaInput").value;
    if (!cat) return alert('Ingrese una categor铆a');
    fetch(`/productos/categoria/${cat}`)
      .then(res => res.json())
      .then(lista => mostrarProductos(lista))
      .catch(() => alert("No se encontraron productos"));
  }

  function buscarPorStock() {
    const valor = document.getElementById("stockInput").value;
    if (!valor) return alert('Ingrese un valor para stock');
    fetch(`/productos/stock?valor=${valor}`)
      .then(res => res.json())
      .then(lista => mostrarProductos(lista))
      .catch(() => alert("No se encontraron productos con bajo stock"));
  }

  function mostrarProducto(p) {
    const container = document.getElementById("producto-container");
    const precio = p.precios[0]?.valor ?? 0;
    const precioId = p.precios[0]?.id ?? null;

    container.innerHTML = `
      <div class="producto">
        <h2>${p.nombre}</h2>
        <p><strong>C贸digo:</strong> ${p.codigoProducto}</p>
        <p><strong>Marca:</strong> ${p.marca}</p>
        <p><strong>Modelo:</strong> ${p.modelo}</p>
        <p><strong>Stock:</strong> ${p.stock}</p>
        <p><strong>Categor铆a:</strong> ${p.categoria}</p>
        <p><strong>Precio CLP:</strong> $${precio}</p>
        ${precioId ? `
          <button onclick="convertirPrecio(${precioId}, 'USD')">Convertir a USD</button>
          <button onclick="convertirPrecio(${precioId}, 'EUR')">Convertir a EUR</button>
          <button onclick='agregarAlCarrito(${JSON.stringify({...p, precio}).replace(/'/g,"\\'")})'>Agregar al carrito</button>
        ` : '<p style="color:red;">Sin precio asociado</p>'}
      </div>
    `;
    document.getElementById("precio-convertido").innerHTML = "";
  }

  function mostrarProductos(lista) {
    const container = document.getElementById("producto-container");
    container.innerHTML = lista.map(p => {
      const precio = p.precios[0]?.valor ?? 0;
      const precioId = p.precios[0]?.id ?? null;
      return `
        <div class="producto">
          <h2>${p.nombre}</h2>
          <p><strong>C贸digo:</strong> ${p.codigoProducto}</p>
          <p><strong>Marca:</strong> ${p.marca}</p>
          <p><strong>Modelo:</strong> ${p.modelo}</p>
          <p><strong>Stock:</strong> ${p.stock}</p>
          <p><strong>Categor铆a:</strong> ${p.categoria}</p>
          <p><strong>Precio CLP:</strong> $${precio}</p>
          ${precioId ? `
            <button onclick="convertirPrecio(${precioId}, 'USD')">Convertir a USD</button>
            <button onclick="convertirPrecio(${precioId}, 'EUR')">Convertir a EUR</button>
            <button onclick='agregarAlCarrito(${JSON.stringify({...p, precio}).replace(/'/g,"\\'")})'>Agregar al carrito</button>
          ` : '<p style="color:red;">Sin precio asociado</p>'}
        </div>
      `;
    }).join('');
    document.getElementById("precio-convertido").innerHTML = "";
  }

  function convertirPrecio(id, moneda) {
    fetch(`/precios/convertir/${id}/${moneda}`)
      .then(res => {
        if (!res.ok) throw new Error("Error");
        return res.json();
      })
      .then(data => {
        document.getElementById("precio-convertido").innerHTML = `
          <p> Precio en ${moneda}: <strong>${data.valorConvertido.toFixed(2)} ${moneda}</strong></p>
        `;
      })
      .catch(() => {
        document.getElementById("precio-convertido").innerHTML = `<p style="color:red;">Error al convertir el precio.</p>`;
      });
  }

  // Funci贸n para pagar todos los productos en carrito
  function pagarCarrito() {
    if (carrito.length === 0) {
      alert("El carrito est谩 vac铆o.");
      return;
    }
    const total = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);

    fetch('/webpay/pagar', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ monto: total })
    })
    .then(res => {
      if (!res.ok) throw new Error("Error al crear transacci贸n");
      return res.json();
    })
    .then(data => {
      // Redirigir a Webpay con token_ws
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = data.url;

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'token_ws';
      input.value = data.token;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    })
    .catch(err => {
      alert("Error al iniciar el pago: " + err.message);
    });
  }

  // Inicializamos el carrito en carga
  actualizarCarrito();
</script>
</body>
</html>
